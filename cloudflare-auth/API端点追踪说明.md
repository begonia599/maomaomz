# 🔥 API 端点追踪系统 - 抓第三方商业化

## 系统功能

这个授权系统现在可以**追踪用户使用的 API 端点**，用于发现和抓捕第三方商业化倒卖行为！

## 工作原理

### 前端自动收集
- 用户验证授权码时，插件会自动读取当前使用的 API 端点
- 从 SillyTavern 配置中获取 `api_server` 或 `main_api`
- 只发送域名部分（如 `api.openai.com`），不发送完整 URL（保护隐私）

### 后端记录和分析
- 记录每个 API 端点的：
  - 访问次数
  - 首次/最后访问时间
  - 使用的 IP 地址列表
  - IP 对应的国家

### 管理后台显示
- **高风险标记**：访问次数超过 50 次的端点会被标记为高风险（⚠️ 红色）
- **排序**：按访问次数从高到低排序
- **IP 详情**：可以展开查看每个端点的所有访问 IP

## 如何抓第三方

### 1. 识别可疑端点
查看 API 端点列表，寻找以下特征：
- ✅ **访问次数异常高** - 正常用户一般不会频繁验证
- ✅ **多个不同 IP 访问** - 表明不是个人使用
- ✅ **商业化 API 服务商域名** - 如自建的转发服务

### 2. 分析案例

#### 示例 1：正常使用
```
🌐 api.openai.com
访问次数: 5 | 独立IP: 1 | 首次: 2025-11-10
📍 123.45.67.89 (CN) - 访问5次
```
**判断**：同一个人在家使用，正常。

#### 示例 2：可疑商业化
```
⚠️ 高风险 | 🌐 my-ai-service.com
访问次数: 156 | 独立IP: 45 | 首次: 2025-11-05
📍 101.202.100.1 (CN) - 访问34次
📍 121.43.178.82 (CN) - 访问28次
📍 183.234.56.78 (CN) - 访问21次
... 更多IP
```
**判断**：
- ✅ 访问次数非常高（156次）
- ✅ 独立 IP 众多（45个）
- ✅ 域名疑似自建服务
- **结论**：极大可能是商业化倒卖！

### 3. 采取行动

发现商业化行为后，你可以：

1. **封禁端点**（需要自行实现）
   - 在后端添加黑名单功能
   - 如果验证请求来自黑名单端点，拒绝授权

2. **联系举报**
   - 记录证据（截图、日志）
   - 在 Discord 社区公开曝光
   - 警告用户不要使用该服务

3. **法律行动**
   - 如果情节严重，可以考虑法律手段
   - 保存完整的访问日志作为证据

## 验证日志中的端点信息

每条验证日志现在都会显示使用的 API 端点：

```
✅ MEOW-20251110-ABCD | IP: 123.45.67.89 (CN)
🌐 API: api.openai.com
```

这样你可以看到：
- 哪些授权码被使用了
- 使用时的 API 端点
- 是否有异常的端点访问

## 数据存储

所有数据存储在 Cloudflare KV 中：
- **键名**：`api_endpoints`
- **数据结构**：
  ```json
  {
    "api.openai.com": {
      "endpoint": "api.openai.com",
      "firstAccess": "2025-11-10T10:00:00.000Z",
      "lastAccess": "2025-11-10T12:00:00.000Z",
      "accessCount": 5,
      "ips": {
        "123.45.67.89": {
          "country": "CN",
          "firstSeen": "2025-11-10T10:00:00.000Z",
          "lastSeen": "2025-11-10T12:00:00.000Z",
          "count": 5
        }
      }
    }
  }
  ```

## 隐私保护

虽然我们追踪 API 端点，但我们保护用户隐私：
- ✅ **不保存完整 URL**：只保存域名
- ✅ **不保存 API 密钥**：永远不会收集
- ✅ **IP 匿名化**：只用于识别独立用户，不做其他用途
- ✅ **不保存个人信息**：没有账号、邮箱、电话等

## 管理后台使用

1. 访问你的 Worker URL（如 `https://你的worker.workers.dev`）
2. 输入管理员密钥
3. 查看 **API端点统计** 区域
4. 点击 **查看IP详情** 展开详细信息
5. 寻找高风险端点（红色标记）

## ⚠️ 重要提醒

这个功能的目的是：
- ✅ 打击商业化倒卖行为
- ✅ 保护免费资源不被滥用
- ✅ 维护社区的公平性

**不要用于：**
- ❌ 侵犯用户隐私
- ❌ 非法追踪用户
- ❌ 其他违法行为

---

**🐱 猫猫的小破烂**  
作者: mzrodyu  
⚠️ 商业化死全家，贩子死全家 ⚠️

